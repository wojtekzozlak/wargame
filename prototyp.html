<html>
  <head>
  </head>
  <body>
    Ship A
<!--    <textarea id="logic1" style="width: 400px; height: 200px;">env.targetAngle = (env.currentAngle + 1) % 360;
env.targetSpeed = 1;</textarea>
    Ship B
    <textarea id="logic2" style="width: 400px; height: 200px;">env.targetAngle = (env.currentAngle + 1) % 360;
env.targetSpeed = 2;
env.shoot = true;</textarea> -->
    <textarea id="logic1" style="width: 400px; height: 200px;">env.targetAngle = 180;
env.targetSpeed = 100;</textarea>
    Ship B
    <textarea id="logic2" style="width: 400px; height: 200px;">
env.targetAngle = env.targetAngle + env.relativeAngles[0];
env.targetSpeed = 150;
if (env.distances[0] < 150) {
  env.shoot = true;
}</textarea>
    <input type="button" value="run" onclick="run();"/>
    <canvas id="game" width="1024" height="768"></canvas>
   	<script>

var TIME_LIMIT = 10000;
var FPS = 50;
var DELTA_PER_FRAME = 1000 / FPS;

var Visualization = function(canvas) {
  this._canvas = canvas;
  this._renderers = {};
};

Visualization.prototype.renderFrame = function(frame) {
  var ctx = this._canvas.getContext("2d");
  ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);
  for (var i = 0; i < frame.length; ++i) {
  	var object = frame[i];
  	ctx.save();
    ctx.translate(400, 400);
    ctx.translate(object.x, object.y);
    ctx.rotate(object.angle * Math.PI / 180);
    this._renderers[object.typeId](ctx);
    ctx.restore();

    for (var j = 0; j < object.messages.length; ++j) {
      console.log(object.messages[j]);
    }
  }
}

Visualization.prototype.registerRenderer = function(type_id, renderer) {
  this._renderers[type_id] = renderer;
}

var shipRenderer = function(ctx) {
  ctx.fillStyle = '#000000';
  ctx.beginPath();
  ctx.moveTo(0, 15);
  ctx.lineTo(10, -15);
  ctx.lineTo(-10, -15);
  ctx.closePath();
  ctx.fill();
}

var rocketRenderer = function(ctx) {
  ctx.fillRect(-2, -10, 4, 20);
}

var timer_id = null;
var run = function() {
  clearTimeout(timer_id);
  var sim = new Simulation();
  for (var i = 1; i <= 2; ++i) {
    var logic = document.getElementById("logic" + i).value;
    var ship = new Ship(200 * (i - 1), 50 * (i - 1), 180 * (i - 1), logic, "player" + i);
    ship.registerModule("engine", new EngineModule());
    ship.registerModule("weapons", new WeaponModule(sim));
    ship.registerModule("sensors", new SensorModule(sim));
    sim.addObject(ship);
  }

  var viz = new Visualization(document.getElementById("game"));
  viz.registerRenderer(ObjectType.SHIP, shipRenderer);
  viz.registerRenderer(ObjectType.ROCKET, rocketRenderer);

  var frames = [];
  for (var i = 0; !sim.finished() && i < TIME_LIMIT; i+=DELTA_PER_FRAME) {
    sim.computeStep(DELTA_PER_FRAME);
    frames.push(sim.dumpFrame());
  }

  var i = 0;
  timer_id = setInterval(function() {
    if (i == frames.length) {
  	  clearTimeout(timer_id);
  	  return;
  	}

  	viz.renderFrame(frames[i]);
  	++i;
  }, DELTA_PER_FRAME);
};


  	</script>
  </body>
</html>
