{% load staticfiles %}
<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="{% static "js/jquery.cookie.js" %}"></script>
    <script src="{% static "js/lib.js" %}"></script>
    <script src="{% static "js/visualization.js" %}"></script>
    <script src="http://www.jsviews.com/download/jsrender.js"></script>
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">
    <link href="{% static "codemirror/codemirror.css" %}" rel="stylesheet">
    <script src="{% static "codemirror/codemirror.js" %}"></script>
    <script src="{% static "codemirror/mode/javascript/javascript.js" %}"></script>
    <script src="{% static "codemirror/addon/edit/matchbrackets.js" %}"></script>
    <script src="{% static "codemirror/addon/edit/trailingspace.js" %}"></script>

    <script src="{% static "js/ai_editor.js" %}"></script>
    <style>
      .simulation {
        display: table;
        height: 400px;
        width: 100%;
        overflow: auto;
      }
      .board {
        border: solid 1px black;
        background-color: gray;
        display: table-cell;
        position: relative;
      }
      .board canvas {
        width: 100%;
        height: 100%;
      }
      .board div.board-controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        text-align: right;
      }
      .simulation .side-panel {
        width: 250px;
        border: solid 1px black;
        display: table-cell;
        vertical-align: top;
        padding: 15px;
      }
      #log {
        padding: 10px;
      }
      #log li.error {
        color: red;
      }
      div#popups {
        z-index: 999;
        position: absolute;
        top: 10%;
        left: 10%;
        width: 80%;
      }
      div#popups div.popup {
        display: none; 
        height: 40px;
        font-size: 30px;
        text-align: center;
        border-radius: 20px;
        z-index: 999;
        margin: 10px;
      }
      div#popups div.popup.info {
        background-color: rgba(0, 255, 0, 0.7);
      }
      div#popups div.popup.error {
        background-color: rgba(255, 0, 0, 0.7);
      }

      .editor-box {
        width: 45%;
        display: inline-block;
      }
      .CodeMirror {
        border: solid 1px #999;
      }
      .cm-trailingspace {
        text-decoration: underline;
        color: #A99;
      }

      div#editor div.side-panel {
        margin-left: 20px;
        display: inline-block;
      }
      div.ai-list {
        display: inline-block;
      }
      div.ai-list ul {
        list-style: none;
        padding: 0px;
      }
      div.ai-list li.selected {
        background-color: yellow;
      }
      div.ai-list li {
        padding: 10px;
        cursor: pointer;
      }
      input.new-ai {
        display: inline-block;
      }
      div.ai-editor {
        width: 70%;
        float: left;
      }
      div.ai-editor div.CodeMirror.disabled {
        background-color: #EEE;
      }
      input.ai-name, input.new-ai {
        width: 200px;
        margin: 5px;
      }
      select.form-control {
        width: auto;
      }
      div#log ul.events {
        list-style-type: square;
        height: 100px;
        overflow: auto;
        padding-top: 2px;
       padding-bottom: 2px;
      }
    </style>
  </head>
  <body>
<div id="top-bar">
  <a href="{% url 'help' %}">manual</a> |
  logged as: {{ request.user.username }} <a href="{% url 'logout' %}?next=/">log out</a>
</div>
<div id="popups"></div>
<div class="simulation">
  <div class="board">
    <canvas class="game"></canvas>
    <div class="board-controls">
      <div class="status"></div>
      <input type="button" class="zoom-in btn btn-success" value="+"/>
      <input type="button" class="zoom-out btn btn-success" value="-"/>
    </div>
  </div>
  <div class="side-panel">
    <div id="controls">
      <input type="button" value="▶" class="play btn btn-success" title="play"/>
      <input type="button" value="||" class="pause btn btn-warning" title="pause"/>
      <input type="button" value="■" class="stop btn btn-danger" title="stop"/>
    </div>
    <div id="log">
      <div class="timer"></div>
      <ul class="events well"></ul>
    </div>
    <div id="players-picker">
      Player A: <select class="player-a form-control"></select><br/>
      Player B: <select class="player-b form-control"></select><br/>
      <input type="button" value="compile and run" class="compile btn btn-primary" title="play"/>
    </div>
  </div>
</div>
<div id="editor">
  <input type="text" class="ai-name form-control"/>
  <div class="ai-editor"></div>
  <div class="side-panel">
    <div class="ai-list"></div><br/>
    <div>
      <input type="text" class="new-ai form-control" placeholder="ai name"/>
      <input type="button" class="add btn btn-primary" value="add"/><br/>
      <input type="button" class="save btn btn-success" value="save"/>
      <input type="button" class="discard btn btn-warning" value="discard changes"/>
      <input type="button" class="delete btn btn-danger" value="delete"/>
    </div>
  </div>
</div>

   	<script>



var PanHandler = function(obj, move_callback) {
  this._moveCallback = move_callback;
  this._offset = [0, 0];
  this._startPosition = null;
  this._enabled = false;

  // TODO(wzoltak): Clean this up.
  $(obj).mousedown($.proxy(function(event) {
    this._startPosition = [event.clientX, event.clientY];
  }, this));
  $(obj).mousemove($.proxy(function(event) {
    if (this._startPosition == null) {
      return false;
    }
    var new_offset = this._GetNewOffset(event);
    this._moveCallback(new_offset[0], new_offset[1]);
    // Disable text selection by cancelling the event.
    return false;
  }, this));
  
  $(obj).mouseout($.proxy(function(event) {
    if (this._startPosition == null) {
      return false;
    }
    this._offset = this._GetNewOffset(event);
    this._startPosition = null;
    return false;
  }, this));
  $(obj).mouseup($.proxy(function(event) {
    if (this._startPosition == null) {
      return false;
    }
    this._offset = this._GetNewOffset(event);
    this._startPosition = null;
  }, this));
};
PanHandler.prototype._GetNewOffset = function(event) {
  var delta_x = event.clientX - this._startPosition[0];
  var delta_y = event.clientY - this._startPosition[1];
  return [this._offset[0] + delta_x, this._offset[1] + delta_y];
};

var Visualization = function(board, log) {
  this._board = board;
  this._canvas = $('canvas.game', board)[0];
  this._renderers = {};
  this._log = log;
  this._zoomFactor = 1;
  this._translation = [0, 0];
  this._lastFrame = null;

  var pan = new PanHandler(this._canvas, $.proxy(function(x, y) {
    this._translation = [x, y];
    this.refresh();
  }, this));

  $('.zoom-in', board).click($.proxy(this._zoomIn, this));
  $('.zoom-out', board).click($.proxy(this._zoomOut, this));
  $(this._canvas).bind('mousewheel', $.proxy(function(event) {
    var wheel_delta = event.originalEvent.wheelDelta;
    if (wheel_delta > 0) {
      this._zoomIn();
    } else {
      this._zoomOut();
    }
    event.stopPropagation();
    return false;
  }, this));

  this.refresh();
};
Visualization.prototype._zoomIn = function() {
  this._zoomFactor *= 1.1;
  this.refresh();
};
Visualization.prototype._zoomOut = function() {
  this._zoomFactor *= 0.9;
  this._zoomFactor = Math.max(this._zoomFactor, 0.2);
  this.refresh();
};
Visualization.prototype.refresh = function() {
  var zoom_factor_txt = 'zoom: ' + this._zoomFactor.toFixed(2);
  var offset_txt = 'x: ' + this._translation[0] + ' y:' + this._translation[1];
  $('div.status', this._board).html(zoom_factor_txt + '<br/>' + offset_txt);
  if (this._lastFrame != null) {
    this.renderFrame(this._lastFrame);
  }
};
Visualization.prototype.renderFrame = function(frame) {
  this._lastFrame = frame;
  var ctx = this._canvas.getContext("2d");
  ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);
  ctx.save();
  ctx.translate(Math.floor(this._canvas.width / 2) + this._translation[0],
                Math.floor(this._canvas.height / 2) + this._translation[1]);
  ctx.scale(0.5 * this._zoomFactor, 0.5 * this._zoomFactor);

  for (var i = 0; i < frame.length; ++i) {
    var object = frame[i];
    ctx.save();
    ctx.translate(object.x, object.y);
    ctx.rotate(object.angle * Math.PI / 180);

    this._renderers[object.typeId](ctx);
    ctx.restore();

    for (var j = 0; j < object.messages.length; ++j) {
      this._log.logMessage(object.faction, object.messages[j]);
    }
  }
  ctx.restore();
};
Visualization.prototype.registerRenderer = function(type_id, renderer) {
  this._renderers[type_id] = renderer;
};
Visualization.prototype.clearCanvas = function() {
  this._lastFrame = null;
  var ctx = this._canvas.getContext("2d");
  ctx.clearRect(0, 0, this._canvas.width, this._canvas.height);
};

var shipRenderer = function(ctx) {
  ctx.fillStyle = '#000000';
  ctx.beginPath();
  ctx.moveTo(0, 15);
  ctx.lineTo(10, -15);
  ctx.lineTo(-10, -15);
  ctx.closePath();
  ctx.fill();

  ctx.beginPath();
  ctx.moveTo(0, -500);
  ctx.lineTo(0, 500);
  ctx.closePath();
  ctx.stroke();
}

var rocketRenderer = function(ctx) {
  ctx.fillStyle = 'red';
  ctx.fillRect(-2, -10, 4, 20);
}

var log = new Log($('#log').get(0));
var viz = new Visualization($('.board'), log);
viz.registerRenderer('SHIP', shipRenderer);
viz.registerRenderer('ROCKET', rocketRenderer);

var controls = new Controls($('#controls'), viz, log);


var frames = [];

var ShowFrame = function(i) {
  viz.renderFrame(frames[i].contents);
};

var players_picker = new PlayersPicker($('#players-picker'), controls);
var editor = new AiEditor($('div#editor'),
                          $.proxy(players_picker.Refresh, players_picker));


var resizeGui = function() {
  var canvas = $('.board canvas');
  canvas.attr('width', parseInt(canvas.css('width')));
  canvas.attr('height', parseInt(canvas.css('height')));
  viz.refresh();
};

$(document).ready(resizeGui);
$(window).resize(resizeGui);

  	</script>
  </body>
</html>
